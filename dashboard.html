<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Liberian Astronomical Society</title>
    <link rel="icon" href="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        /* --- Global Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background: #0d1117;
            background-image: radial-gradient(circle at 10% 20%, #1e3a8a, #0c4a6e);
            background-attachment: fixed;
            color: #d1d5db;
        }
        .dashboard-card {
            background-color: rgba(17, 24, 39, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Style for the acceptance letter section */
        .acceptance-letter-bg {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.8), rgba(67, 56, 202, 0.8));
            border: 2px solid #3b82f6; /* Blue border */
        }
        /* Simple spinner for loading state */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="dashboard-card p-8 rounded-2xl shadow-2xl w-full max-w-3xl mx-auto transform transition-all duration-300">
        <div class="flex flex-col items-center mb-6 text-center">
            <img src="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png" alt="LAS Logo" class="h-16 w-auto mb-4">
            <h1 class="text-4xl font-bold text-white mb-2">Welcome Back!</h1>
            <p class="text-gray-400 text-lg">Your journey through the cosmos awaits.</p>
        </div>

        <div class="mt-8 p-6 bg-gray-800 rounded-xl border border-gray-700 mb-6">
            <h2 class="text-2xl font-semibold text-white mb-4">Membership Status</h2>
            <div class="flex items-center space-x-4">
                <span class="text-gray-400 text-sm">User ID:</span>
                <span id="userEmailDisplay" class="font-medium text-white">Connecting...</span>
            </div>
            <div class="flex items-center space-x-4 mt-2">
                <span class="text-gray-400 text-sm">Status:</span>
                <span id="membershipStatus" class="font-bold text-yellow-400">Loading...</span>
            </div>
            <p id="pendingMessage" class="mt-4 text-sm text-gray-400 hidden">
                Your membership is pending approval. Please complete your application:
            </p>
            <a id="applicationLink" href="membership_application.html" target="_blank" class="mt-4 hidden inline-block bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:bg-indigo-700 transition-all duration-300">
                Complete Membership Application
            </a>
        </div>
        
        <div id="acceptanceLetterSection" class="acceptance-letter-bg p-6 rounded-xl shadow-inner mb-6 hidden">
            <h2 class="text-3xl font-bold text-white mb-4 text-center">ðŸŽ‰ Congratulations! Your Application is Approved! ðŸŽ‰</h2>
            <div id="letterContent" class="bg-white/10 p-6 rounded-lg backdrop-blur-sm text-gray-200">
                <p class="text-xl font-semibold text-white mb-4">
                    Dear <strong id="memberName" class="text-indigo-300">Member</strong>,
                </p>

                <p class="mb-6 leading-relaxed">
                    Congratulations! On behalf of the Liberian Astronomical Society, we are pleased to inform you that you have been officially accepted as a member of our great community. We welcome you to our growing community of astronomy and space science enthusiasts!
                </p>
                
                <p class="font-semibold text-white mt-4 mb-2">As a member, you will have access to:</p>
                <ul class="list-disc list-inside space-y-2 ml-4 mb-6">
                    <li>Training programs and workshops (including asteroids hunting and telescope training).</li>
                    <li>Participation in national and international research projects.</li>
                    <li>Exclusive updates, resources, and opportunities to contribute to astronomy outreach in Liberia.</li>
                </ul>

                <p class="font-semibold text-white mt-6 mb-2">Membership Renewal Fees:</p>
                <div class="bg-gray-700/50 p-4 rounded-lg space-y-1 text-sm">
                    <p><strong class="text-indigo-300">Students:</strong> $500 LRD / monthly</p>
                    <p><strong class="text-indigo-300">Teachers:</strong> $5 USD / monthly</p>
                    <p><strong class="text-indigo-300">Professors:</strong> $15 USD / monthly</p>
                </div>

                <p class="mt-6 mb-6 leading-relaxed">
                    We are excited to have you on board and look forward to your active participation in our programs. Together we will inspire curiosity, promote scientific literacy, and build Liberia's presence in the global astronomy community.
                </p>

                <p class="mt-4 text-sm text-indigo-400">
                    Once again, welcome to the LAS family.
                    <br>
                    â€” LAS Administrators
                </p>
            </div>
            <div id="confirmationActions" class="mt-6 flex flex-col sm:flex-row gap-3">
                <button id="downloadLetterButton" class="w-full sm:w-auto bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-700 transition-all duration-300 flex-shrink-0">
                    Download Letter (PDF)
                </button>
                <button id="acceptButton" class="w-full sm:w-auto bg-green-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-green-700 transition-all duration-300 flex-grow">
                    Accept Membership
                </button>
                <button id="declineButton" class="w-full sm:w-auto bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition-all duration-300 flex-shrink-0">
                    Decline Offer
                </button>
            </div>
        </div>
        
        <div class="mt-6 p-6 bg-gray-800 rounded-xl border border-gray-700 mb-6">
            <h2 class="text-2xl font-semibold text-white mb-4">Member-Only Resources</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-700 p-6 rounded-lg border border-gray-600">
                    <h3 class="text-lg font-semibold text-white mb-2">Celestial Object Finder</h3>
                    <p class="text-gray-400 text-sm mb-4">Search for planets, stars, and constellations using AI.</p>
                    <div class="flex space-x-2">
                        <input type="text" id="objectSearchInput" placeholder="e.g. Jupiter" class="w-full px-4 py-2 bg-gray-900 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="searchButton" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition-all duration-300">
                            Search
                        </button>
                    </div>
                    <div id="searchResults" class="mt-4 text-gray-300 text-sm leading-relaxed">
                        Ready to search for a star or planet!
                    </div>
                </div>

                <div class="bg-gray-700 p-6 rounded-lg border border-gray-600">
                    <h3 class="text-lg font-semibold text-white mb-2">Upcoming Events</h3>
                    <p class="text-gray-400 text-sm">Check back soon for details on our next star-gazing events and workshops!</p>
                </div>
            </div>
        </div>

        <button id="logoutButton" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:focus:ring-offset-gray-900 transition-all duration-300">
            Log Out
        </button>
    </div>

    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
            <h3 id="messageTitle" class="text-xl font-bold text-white mb-3">Message</h3>
            <p id="messageText" class="text-gray-300 mb-6"></p>
            <button id="closeMessageBox" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-all duration-300">Close</button>
        </div>
    </div>
    
    <div id="signUpForm" class="hidden absolute top-0 left-0">
        <input type="email" id="signupEmail" placeholder="Email">
        <input type="password" id="signupPassword" placeholder="Password">
        <button id="signupButton">Sign Up</button>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS (using required version 11.6.1) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- API CONFIGURATION ---
        const apiKey = "AIzaSyAX8le3vbPja0UfSUR2UvEMCkUxkQQPvks";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 3;

        // Utility function for exponential backoff
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- FIREBASE INITIALIZATION & GLOBAL VARS ---
        // ----- START: YOUR FIREBASE CONFIGURATION -----
        const firebaseConfig = {
            apiKey: "AIzaSyAX8le3vbPja0UfSUR2UvEMCkUxkQQPvks",
            authDomain: "liberian-astro-society.firebaseapp.com",
            projectId: "liberian-astro-society",
            storageBucket: "liberian-astro-society.firebasestorage.app",
            messagingSenderId: "914979035379",
            appId: "1:914979035379:web:ad9a2dbb05ebd48c407f86",
            measurementId: "G-RBC64CGK4J"
        };
        // ----- END: YOUR FIREBASE CONFIGURATION -----

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserName = "LAS Member"; // Default name
        let userDocRef; // Reference to the user's status document

        // DOM Elements
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const membershipStatus = document.getElementById('membershipStatus');
        const pendingMessage = document.getElementById('pendingMessage');
        const applicationLink = document.getElementById('applicationLink');
        const acceptanceLetterSection = document.getElementById('acceptanceLetterSection');
        const memberName = document.getElementById('memberName');
        const logoutButton = document.getElementById('logoutButton');
        const downloadLetterButton = document.getElementById('downloadLetterButton');
        const acceptButton = document.getElementById('acceptButton');
        const declineButton = document.getElementById('declineButton');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const closeMessageBox = document.getElementById('closeMessageBox');
        const objectSearchInput = document.getElementById('objectSearchInput');
        const searchButton = document.getElementById('searchButton');
        const searchResults = document.getElementById('searchResults');
        
        // New DOM elements for sign-up form placeholder
        const signupButton = document.getElementById('signupButton');
        const signupEmailInput = document.getElementById('signupEmail');
        const signupPasswordInput = document.getElementById('signupPassword');
        
        // ------------------------------------
        // --- 1. CORE FIREBASE INITIALIZATION ---
        // ------------------------------------
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase App Initialized.");
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            displayMessage('Error', 'Failed to initialize Firebase. Check your config and network connection.', 'error');
        }

        // ------------------------------------
        // --- 2. MEMBERSHIP STATUS HANDLERS ---
        // ------------------------------------
        
        const statusToColor = (status) => {
            switch (status) {
                case 'Approved':
                    return 'text-green-400';
                case 'Pending':
                    return 'text-yellow-400';
                case 'Declined':
                    return 'text-red-500';
                case 'Accepted': 
                case 'Incomplete':
                default:
                    return 'text-red-400';
            }
        };

        const updateDashboard = (statusKey, displayText, colorClass, name = "Member", isAccepted = false) => {
            membershipStatus.textContent = displayText;
            membershipStatus.className = `font-bold ${colorClass}`;
            memberName.textContent = name;

            // Hide everything first
            pendingMessage.classList.add('hidden');
            applicationLink.classList.add('hidden');
            acceptanceLetterSection.classList.add('hidden');

            // Show relevant sections based on status
            if (statusKey === 'Incomplete') {
                pendingMessage.classList.remove('hidden');
                applicationLink.classList.remove('hidden');
                membershipStatus.textContent = 'Application Incomplete';
            } else if (statusKey === 'Approved' && !isAccepted) {
                acceptanceLetterSection.classList.remove('hidden');
            } else if (statusKey === 'Accepted' || (statusKey === 'Approved' && isAccepted)) {
                membershipStatus.textContent = 'Active Member';
                membershipStatus.className = `font-bold text-green-500`;
            }
        };

        const handleUserStatusUpdate = (docSnapshot) => {
            if (!docSnapshot.exists()) {
                console.warn("User document not found. Setting status to Incomplete.");
                // Create document with initial status
                setDoc(userDocRef, {
                    status: 'Incomplete',
                    name: currentUserName,
                    email: currentUserId,
                    accepted: false
                }, { merge: true });
                updateDashboard('Incomplete', 'Application Incomplete', 'text-red-400');
                return;
            }

            const userData = docSnapshot.data();
            const status = userData.status || 'Pending';
            currentUserName = userData.name || currentUserId.split('@')[0] || "LAS Member";
            const accepted = userData.accepted || false;

            updateDashboard(status, status, statusToColor(status), currentUserName, accepted);
        };

        // ------------------------------------
        // --- 3. AUTHENTICATION & LISTENER ---
        // ------------------------------------

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.email || user.uid;
                userEmailDisplay.textContent = currentUserId;

                // Start Firestore Listener
                userDocRef = doc(db, "members", user.uid);
                
                onSnapshot(userDocRef, handleUserStatusUpdate, (error) => {
                    console.error("Firestore Listener Error:", error);
                    updateDashboard('Error', 'Connection Error', 'text-red-500');
                    displayMessage('Database Error', 'Could not fetch real-time membership status.', 'error');
                });
                
            } else if (initialAuthToken) {
                // Sign in with custom token (e.g., from a server)
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom Token Sign-In Failed:", error);
                    userEmailDisplay.textContent = 'Token expired/invalid. Signing in anonymously...';
                    await signInAnonymously(auth); 
                }
            } else {
                // Fallback: Sign in anonymously for basic dashboard access
                try {
                    await signInAnonymously(auth);
                    userEmailDisplay.textContent = 'Guest User (Anonymous)';
                } catch (error) {
                    console.error("Anonymous Sign-In Failed:", error);
                    userEmailDisplay.textContent = 'Login Failed';
                    membershipStatus.textContent = 'Not Logged In';
                    membershipStatus.className = 'font-bold text-red-500';
                }
            }
        });

        // ------------------------------------
        // --- 4. NEW: USER SIGN-UP HANDLER ---
        // ------------------------------------

        /**
         * Creates a new user in Firebase Auth and immediately sets their
         * membership status to 'Incomplete' in Firestore.
         */
        async function handleNewUserSignUp(email, password) {
            if (!auth || !db) {
                displayMessage('Error', 'System not initialized. Please try reloading the page.', 'error');
                return;
            }

            try {
                // 1. Create the user with Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. *** CRITICAL STEP: Create the initial membership document ***
                if (user) {
                    const userDocRef = doc(db, "members", user.uid);
                    await setDoc(userDocRef, {
                        // Set the initial status to 'Incomplete'
                        status: 'Incomplete', 
                        name: user.email.split('@')[0] || "New Member", 
                        email: user.email,
                        accepted: false
                    }, { merge: true });

                    // 3. Success Feedback and Redirection
                    console.log(`User ${user.email} created and status set to Incomplete.`);
                    window.location.href = 'dashboard.html'; // Redirect to dashboard
                }

            } catch (error) {
                let errorMessage = "An unknown error occurred during sign up.";
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'The email address is already in use by another account.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'The email address is not valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'The password must be at least 6 characters long.';
                }
                
                console.error("Sign up failed:", error);
                displayMessage('Sign Up Failed', errorMessage, 'error');
            }
        }
        
        // ------------------------------------
        // --- 5. DASHBOARD ACTION HANDLERS ---
        // ------------------------------------
        
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                displayMessage('Logout Error', 'An error occurred during sign out.', 'error');
            }
        });

        // Placeholder Listener for the hypothetical Sign-Up button
        if (signupButton) {
            signupButton.addEventListener('click', () => {
                const email = signupEmailInput.value;
                const password = signupPasswordInput.value;
                
                if (email && password) {
                    handleNewUserSignUp(email, password);
                } else {
                    displayMessage('Error', 'Please enter a valid email and password.', 'error');
                }
            });
        }

        acceptButton.addEventListener('click', async () => {
            if (!userDocRef) return displayMessage('Error', 'User data not loaded yet.', 'error');
            
            try {
                await updateDoc(userDocRef, {
                    accepted: true,
                    status: 'Accepted'
                });
                displayMessage('Success!', 'Welcome to LAS! Your membership is now active.', 'success');
            } catch (error) {
                displayMessage('Error', 'Failed to update membership status. Please check Firestore rules.', 'error');
            }
        });

        declineButton.addEventListener('click', async () => {
            if (!userDocRef) return displayMessage('Error', 'User data not loaded yet.', 'error');
            
            try {
                await updateDoc(userDocRef, { status: 'Declined' });
                displayMessage('Offer Declined', 'You have declined the membership offer.', 'info');
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                displayMessage('Error', 'Failed to update status.', 'error');
            }
        });

       // Download Letter (PDF generation)
        downloadLetterButton.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Initialize with standard size

            const element = document.getElementById('letterContent');
            
            // Use the recommended html() method for modern jsPDF
            doc.html(element, {
                callback: function (doc) {
                    doc.save('LAS_Acceptance_Letter.pdf');
                },
                x: 10,
                y: 10,
                html2canvas: { 
                    scale: 0.5 // Scale down content to fit A4 well
                } 
            });
        });


        // ------------------------------------
        // --- 6. UTILITY FUNCTIONS (Messaging) ---
        // ------------------------------------

        function displayMessage(title, text, type = 'info') {
            messageTitle.textContent = title;
            messageText.textContent = text;
            
            let color = 'text-white';
            if (type === 'error') color = 'text-red-400';
            if (type === 'success') color = 'text-green-400';
            messageTitle.className = `text-xl font-bold mb-3 ${color}`;
            
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        closeMessageBox.addEventListener('click', () => {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
        });
        
        // ------------------------------------
        // --- 7. GEMINI API (Celestial Search) ---
        // ------------------------------------
        
        searchButton.addEventListener('click', async () => {
            const query = objectSearchInput.value.trim();
            if (!query) {
                searchResults.textContent = "Please enter an astronomical object to search.";
                return;
            }

            searchResults.innerHTML = '<div class="loader inline-block mr-2"></div> Searching...';

            const prompt = `You are an expert astronomer for the Liberian Astronomical Society. Provide a brief, engaging, and informative description (max 100 words) of the celestial object: "${query}". Include one interesting fact about it.`;
            
            let result = "Could not connect to the astronomical database (API error).";

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: "user", parts: [{ text: prompt }] }],
                            config: { temperature: 0.7, maxOutputTokens: 200 }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Rate limit error
                            await delay(Math.pow(2, i) * 1000); // Exponential backoff
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates.length > 0) {
                        result = data.candidates[0].content.parts[0].text;
                    } else {
                        result = "The search produced an empty result. Try a different object name.";
                    }
                    break; 

                } catch (error) {
                    result = `Search failed: ${error.message}`;
                    if (i < MAX_RETRIES - 1) { await delay(Math.pow(2, i) * 1000); }
                }
            }

            searchResults.innerHTML = result.replace(/\*\*/g, '<strong>').replace(/\n/g, '<br>');
        });
        
    </script>
</body>
</html>
