<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LAS Dashboard — Profile · Events · Payments</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 10% 20%, #1e3a8a, #0c4a6e); color: #e5e7eb; min-height:100vh; }
    .glass { background: rgba(17,24,39,0.45); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.06); }
    .muted { color: #9ca3af; }
    .chip { background: rgba(255,255,255,0.03); padding: .25rem .5rem; border-radius: .5rem; font-size: .85rem; }
  </style>
</head>
<body class="p-6 flex items-start justify-center">

<div class="w-full max-w-6xl space-y-6" id="dashboardContainer">

  <!-- Header -->
  <header class="flex items-center justify-between mb-2">
    <div class="flex items-center space-x-4">
      <img src="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png" class="h-12 rounded-full" alt="LAS">
      <div>
        <h1 class="text-2xl font-bold">Liberian Astronomical Society — Dashboard</h1>
        <p class="muted text-sm">Profile · Events · Payments</p>
      </div>
    </div>
    <div class="space-x-3">
      <span id="emailBadge" class="chip">Not signed in</span>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white hidden">Logout</button>
    </div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left column: Profile + Membership Status -->
    <section class="glass p-6 rounded-xl" id="profileSection">
      <h2 class="text-xl font-semibold mb-4">My Profile</h2>
      <div class="space-y-3">
        <img id="previewPhoto" src="" alt="profile" class="h-24 w-24 rounded-full object-cover border" />
        <label class="block text-sm">Full name</label>
        <input id="profileName" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700" />
        <label class="block text-sm mt-2">Role</label>
        <select id="profileRole" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700">
          <option>Student</option>
          <option>Volunteer</option>
          <option>Teacher</option>
          <option>Researcher</option>
          <option>Executive</option>
        </select>
        <label class="block text-sm mt-2">Photo URL</label>
        <input id="profilePhoto" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700" placeholder="https://..." />
        <label class="block text-sm mt-2">Short bio</label>
        <textarea id="profileBio" rows="3" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700"></textarea>

        <div class="flex gap-3 mt-3">
          <button id="saveProfile" class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">Save Profile</button>
          <button id="downloadProfileID" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Download Member ID</button>
        </div>

        <div class="mt-4">
          <p class="muted text-sm">Membership Status:</p>
          <div id="membershipStatus" class="text-lg font-bold">Loading...</div>
        </div>
      </div>
    </section>

    <!-- Middle column: Events and Payments -->
    <section class="col-span-1 lg:col-span-1 space-y-6" id="eventsPaymentsSection">
      <!-- Events -->
      <div class="glass p-6 rounded-xl">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Events</h2>
          <button id="refreshEvents" class="text-sm muted">Refresh</button>
        </div>
        <p class="muted text-sm mb-3">Upcoming LAS events. Click <em>Register</em> to join.</p>
        <div id="eventsList" class="space-y-3 max-h-64 overflow-auto"></div>
      </div>

      <!-- Payments -->
      <div class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">Payments & Dues</h2>
        <p class="muted text-sm mb-3">Your payment history and outstanding dues.</p>
        <div id="paymentsSummary" class="text-sm muted mb-3">Loading...</div>
        <div id="paymentsList" class="space-y-2 max-h-40 overflow-auto"></div>
        <div class="mt-3 flex gap-2">
          <input id="paymentAmount" type="number" placeholder="Amount (USD)" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-full"/>
          <button id="addPaymentBtn" class="bg-indigo-600 px-4 py-2 rounded">Add Payment</button>
        </div>
      </div>
    </section>

    <!-- Right column: Member ID -->
    <section class="space-y-6">
      <div id="memberIDSection" class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">My Member ID</h2>
        <p class="muted text-sm mb-3">View and download your membership ID.</p>
        <div id="memberIDDisplay" class="mb-3">
          <p id="memberName" class="font-semibold"></p>
          <p id="memberRole" class="muted"></p>
          <p id="memberNumber" class="muted"></p>
        </div>
        <button id="downloadMemberID" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Download Member ID</button>
      </div>
    </section>

    <!-- Incomplete / Pending section -->
    <div id="incompleteSection" class="glass p-6 rounded-xl mt-6 hidden col-span-3">
      <h2 class="text-xl font-semibold">Complete Your Membership Application</h2>
      <p class="muted text-sm mb-3">Your membership is not yet fully approved. Please complete your application to access the full dashboard.</p>
      <a href="membership_application.html">
        <button class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">Go to Application Form</button>
      </a>
    </div>

  </main>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAX8le3vbPja0UfSUR2UvEMCkUxkQQPvks",
  authDomain: "liberian-astro-society.firebaseapp.com",
  projectId: "liberian-astro-society",
  storageBucket: "liberian-astro-society.firebasestorage.app",
  messagingSenderId: "914979035379",
  appId: "1:914979035379:web:ad9a2dbb05ebd48c407f86"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const emailBadge = document.getElementById('emailBadge');
const logoutBtn = document.getElementById('logoutBtn');
const incompleteSection = document.getElementById('incompleteSection');
const profileSection = document.getElementById('profileSection');
const eventsPaymentsSection = document.getElementById('eventsPaymentsSection');
const membershipStatusEl = document.getElementById('membershipStatus');

const memberNameEl = document.getElementById('memberName');
const memberRoleEl = document.getElementById('memberRole');
const memberNumberEl = document.getElementById('memberNumber');

// Buttons
const saveProfileBtn = document.getElementById('saveProfile');
const downloadProfileIDBtn = document.getElementById('downloadProfileID');
const downloadMemberIDBtn = document.getElementById('downloadMemberID');
const addPaymentBtn = document.getElementById('addPaymentBtn');
const refreshEventsBtn = document.getElementById('refreshEvents');

onAuthStateChanged(auth, async (user) => {
  if (!user) { await signInAnonymously(auth); return; }

  emailBadge.textContent = user.email || user.uid;
  logoutBtn.classList.remove('hidden');

  const userDocRef = doc(db, 'members', user.uid);
  onSnapshot(userDocRef, (snap) => {
    if (!snap.exists()) {
      setDoc(userDocRef, { status: 'Incomplete', name: user.email ? user.email.split('@')[0] : 'Member', email: user.email || '', role: 'Member' }, { merge: true });
      membershipStatusEl.textContent = 'Incomplete';
      showIncompleteView();
      return;
    }

    const data = snap.data();
    membershipStatusEl.textContent = data.status || 'Pending';
    memberNameEl.textContent = data.name || 'Member Name';
    memberRoleEl.textContent = data.role || 'Role';
    memberNumberEl.textContent = data.memberID || user.uid;

    document.getElementById('profileName').value = data.name || '';
    document.getElementById('profileRole').value = data.role || 'Member';
    document.getElementById('profilePhoto').value = data.photo || '';
    document.getElementById('profileBio').value = data.bio || '';
    document.getElementById('previewPhoto').src = data.photo || '';

    if (data.status === 'Incomplete' || data.status === 'Pending') {
      showIncompleteView();
    } else {
      showFullDashboard();
    }
  });
});

logoutBtn.addEventListener('click', async () => { await signOut(auth); window.location.href = "signup.html"; });

function showIncompleteView() { incompleteSection.classList.remove('hidden'); profileSection.classList.add('hidden'); eventsPaymentsSection.classList.add('hidden'); }
function showFullDashboard() { incompleteSection.classList.add('hidden'); profileSection.classList.remove('hidden'); eventsPaymentsSection.classList.remove('hidden'); }

// Save Profile
saveProfileBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) return;

  const userDocRef = doc(db, 'members', user.uid);
  await setDoc(userDocRef, {
    name: document.getElementById('profileName').value,
    role: document.getElementById('profileRole').value,
    photo: document.getElementById('profilePhoto').value,
    bio: document.getElementById('profileBio').value,
    status: 'Active'
  }, { merge: true });

  document.getElementById('previewPhoto').src = document.getElementById('profilePhoto').value;
  alert('Profile saved!');
});

// Download Member ID
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4'); // portrait, points, A4 size

  // Add border
  doc.setLineWidth(2);
  doc.rect(20, 20, 555, 770); // x, y, width, height

  // Add LAS logo
  const logoUrl = 'https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png';
  const img = new Image();
  img.src = logoUrl;
  img.onload = () => {
    doc.addImage(img, 'PNG', 220, 40, 150, 50); // x, y, width, height

    // Title
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.text('Liberian Astronomical Society', 297.5, 120, { align: 'center' });

    doc.setFontSize(18);
    doc.setFont('helvetica', 'normal');
    doc.text('Membership Certificate', 297.5, 150, { align: 'center' });

    // Member info box
    doc.setFontSize(14);
    doc.text(`Name: ${memberNameEl.textContent}`, 50, 200);
    doc.text(`Role: ${memberRoleEl.textContent}`, 50, 230);
    doc.text(`Member ID: ${memberNumberEl.textContent}`, 50, 260);

    // Footer
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text('This certificate certifies the above individual as a member of the Liberian Astronomical Society.', 50, 700, { maxWidth: 500 });

    // Save PDF
    doc.save('LAS_Member_Certificate.pdf');
  };
}
downloadProfileIDBtn.addEventListener('click', generatePDF);
downloadMemberIDBtn.addEventListener('click', generatePDF);

// Add Payment
addPaymentBtn.addEventListener('click', async () => {
  const amountInput = document.getElementById('paymentAmount');
  const amount = parseFloat(amountInput.value);
  if (isNaN(amount) || amount <= 0) return alert('Enter a valid amount');

  const user = auth.currentUser;
  const paymentsRef = collection(db, 'members', user.uid, 'payments');
  await addDoc(paymentsRef, { amount, date: new Date() });

  amountInput.value = '';
  alert('Payment added!');
  loadPayments();
});

// Refresh Events
refreshEventsBtn.addEventListener('click', loadEvents);

// Load Payments
async function loadPayments() {
  const user = auth.currentUser;
  const paymentsListEl = document.getElementById('paymentsList');
  paymentsListEl.innerHTML = '';

  const paymentsRef = collection(db, 'members', user.uid, 'payments');
  const snapshot = await getDocs(paymentsRef);

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement('div');
    div.textContent = `USD ${data.amount} — ${data.date.toDate().toLocaleDateString()}`;
    paymentsListEl.appendChild(div);
  });
}
// Update profile photo preview live
const profilePhotoInput = document.getElementById('profilePhoto');
const previewPhoto = document.getElementById('previewPhoto');

profilePhotoInput.addEventListener('input', () => {
  previewPhoto.src = profilePhotoInput.value || ''; // empty if no URL
});
previewPhoto.src = profilePhotoInput.value || 'https://via.placeholder.com/150';

// Load Events
async function loadEvents() {
  const eventsListEl = document.getElementById('eventsList');
  eventsListEl.innerHTML = '';

  const eventsSnapshot = await getDocs(collection(db, 'events'));
  eventsSnapshot.forEach(docSnap => {
    const event = docSnap.data();
    const div = document.createElement('div');
    div.classList.add('glass', 'p-2', 'rounded');
    const btnID = 'register_' + docSnap.id;

    div.innerHTML = `
      <p class="font-semibold">${event.title}</p>
      <p class="text-sm muted">${event.date}</p>
      <button id="${btnID}" class="bg-indigo-600 px-2 py-1 mt-1 rounded text-sm hover:bg-indigo-700">Register</button>
    `;

    eventsListEl.appendChild(div);

    // Event registration
    document.getElementById(btnID).addEventListener('click', async () => {
      const user = auth.currentUser;
      const regRef = collection(db, 'members', user.uid, 'registrations');
      await addDoc(regRef, { eventID: docSnap.id, title: event.title, date: new Date() });
      alert(`Registered for ${event.title}`);
    });
  });
}

// Initial load
loadEvents();
loadPayments();
</script>
</body>
</html>

