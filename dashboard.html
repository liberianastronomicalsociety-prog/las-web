<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LAS Dashboard — Profile · Events · Payments</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg,#071126 0%, #011026 60%); color: #e5e7eb; min-height:100vh; }
    .glass { background: rgba(17,24,39,0.45); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
    .muted { color: #9ca3af; }
    .chip { background: rgba(255,255,255,0.03); padding: .25rem .5rem; border-radius: .5rem; font-size: .85rem; }
    .status-pill { font-weight: 700; border-radius: 9999px; padding: .35rem .75rem; display: inline-flex; align-items: center; gap: .5rem; }
  </style>
</head>
<body class="p-6 flex items-start justify-center">

<div class="w-full max-w-6xl space-y-6" id="dashboardContainer">

  <!-- Header -->
  <header class="flex items-center justify-between mb-2">
    <div class="flex items-center space-x-4">
      <img src="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png" class="h-12 rounded-full" alt="LAS">
      <div>
        <h1 class="text-2xl font-bold">Liberian Astronomical Society — Dashboard</h1>
        <p class="muted text-sm">Profile · Events · Payments</p>
      </div>
      <a href="profile.html" id="profileBtn"
        class="bg-indigo-600 px-4 py-2 rounded text-white hidden">
        Profile
      </a>
    </div>
    <div class="space-x-3">
      <span id="emailBadge" class="chip">Not signed in</span>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white hidden">Logout</button>
    </div>
  </header>

  <div id="topNotice" class="hidden max-w-6xl mx-auto p-3 rounded-md text-sm"></div>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left column: Profile + Membership Status -->
    <section class="glass p-6 rounded-xl" id="profileSection">
      <h2 class="text-xl font-semibold mb-2">My Profile</h2>
      
      <div class="mt-4">
        <p class="muted text-sm">Membership status</p>
        <div id="membershipStatus"
          class="inline-flex items-center gap-2 mt-2 status-pill bg-yellow-400 text-gray-900">
          Loading...
        </div>
      </div>
    </section>


    <!-- Middle column: Events and Payments -->
    <section class="col-span-1 lg:col-span-1 space-y-6" id="eventsPaymentsSection">
      <!-- Events -->
      <div class="glass p-6 rounded-xl">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Events</h2>
          <button id="refreshEvents" class="text-sm muted">Refresh</button>
        </div>
        <p class="muted text-sm mb-3">Upcoming LAS events. Click <em>Register</em> to join.</p>
        <div id="eventsList" class="space-y-3 max-h-64 overflow-auto"></div>
      </div>

      <!-- Payments -->
      <div class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">Payments & Dues</h2>
        <p class="muted text-sm mb-3">Your payment history and outstanding dues.</p>
        <div id="paymentsSummary" class="text-sm muted mb-3">Loading...</div>
        <div id="paymentsList" class="space-y-2 max-h-40 overflow-auto"></div>
        <div class="mt-3 flex gap-2">
          <input id="paymentAmount" type="number" placeholder="Amount (USD)" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-full"/>
          <button id="addPaymentBtn" class="bg-indigo-600 px-4 py-2 rounded">Add Payment</button>
        </div>
      </div>
    </section>

    <!-- Right column: Member ID -->
    <section class="space-y-6" id="memberIDSectionWrapper">
      <div id="memberIDSection" class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">My Member ID</h2>
        <p class="muted text-sm mb-3">View and download your membership ID.</p>
        <div id="memberIDDisplay" class="mb-3">
          <p id="memberName" class="font-semibold"></p>
          <p id="memberRole" class="muted"></p>
          <p id="memberNumber" class="muted"></p>
        </div>
        <div class="flex gap-2 mb-3">
          <button id="downloadMemberID" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Download Member ID</button>
          <button id="downloadCertificate" class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700 text-white">Download Certificate</button>
        </div>

        <!-- Certificate settings (signature upload) -->
        <div class="mt-4 border-t pt-4">
          <h4 class="text-sm font-semibold mb-2">Certificate settings</h4>
          <p class="text-xs muted mb-2">Upload the President's signature used on membership certificates.</p>

          <div class="space-y-2">
            <label class="block text-xs">Signature file</label>
            <input id="signatureFile" type="file" accept="image/*" class="text-sm w-full" />

            <label class="block text-xs mt-2">Or use image URL</label>
            <input id="signatureUrl" type="url" placeholder="https://..." class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-white text-sm" />

            <div class="flex items-center gap-3 mt-3">
              <img id="signaturePreview" src="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/Signature.jpg" alt="Signature preview" class="h-12 object-contain" />
              <div class="flex gap-2">
                <button id="saveSignatureBtn" class="bg-green-600 px-3 py-1 rounded text-sm text-white">Save signature</button>
                <button id="useGithubSigBtn" class="bg-gray-700 px-3 py-1 rounded text-sm">Use GitHub signature</button>
              </div>
            </div>
            <p id="signatureAdminNotice" class="text-xs muted mt-2 hidden">Only administrators can update this signature. Contact <a href="mailto:liberianastronomicalsociety@gmail.com" class="underline">admin@liberianastronomicalsociety.org</a> to request changes.</p>
            <div id="signatureAdminBlock" class="mt-4 border-t pt-4 hidden">
          </div>
        </div>
      </div>
    </section>

    <!-- Incomplete / Pending section -->
    <div id="incompleteSection" class="glass p-6 rounded-xl mt-6 hidden col-span-3">
      <h2 class="text-xl font-semibold">Complete Your Membership Application</h2>
      <p class="muted text-sm mb-3">Your membership isn't fully verified yet — please complete your profile or contact an administrator for assistance.</p>
      <div class="flex gap-3">
        <a href="membership_application.html" class="inline-block"><button class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">Complete Application</button></a>
        <a href="mailto:liberianastronomicalsociety@gmail.com" class="inline-block"><button class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600">Contact Admin</button></a>
      </div>
    </div>

  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, onSnapshot, collection,
  addDoc, getDocs, getDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---------------------------
   Firebase Init
--------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAX8le3vbPja0UfSUR2UvEMCkUxkQQPvks",
  authDomain: "liberian-astro-society.firebaseapp.com",
  projectId: "liberian-astro-society",
  storageBucket: "liberian-astro-society.firebasestorage.app",
  messagingSenderId: "914979035379",
  appId: "1:914979035379:web:ad9a2dbb05ebd48c407f86"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------------------
   Global State
--------------------------- */
let currentMembershipStatus = 'incomplete';
let presidentSignature = null;
let siteSettings = {};
let isAdmin = false;

/* ---------------------------
   DOM Elements
--------------------------- */
const emailBadge = document.getElementById('emailBadge');
const profileBtn = document.getElementById('profileBtn');
const logoutBtn = document.getElementById('logoutBtn');
const incompleteSection = document.getElementById('incompleteSection');
const profileSection = document.getElementById('profileSection');
const eventsPaymentsSection = document.getElementById('eventsPaymentsSection');
const memberIDSection = document.getElementById('memberIDSection');
const membershipStatusEl = document.getElementById('membershipStatus');

const memberNameEl = document.getElementById('memberName');
const memberRoleEl = document.getElementById('memberRole');
const memberNumberEl = document.getElementById('memberNumber');

const downloadMemberIDBtn = document.getElementById('downloadMemberID');
const addPaymentBtn = document.getElementById('addPaymentBtn');
const refreshEventsBtn = document.getElementById('refreshEvents');

/* ---------------------------
   Helpers
--------------------------- */
function generateMemberID(uid) {
  const year = new Date().getFullYear();
  const short = uid.slice(-6).toUpperCase();
  return `LAS-${year}-${short}`;
}

function setStatusVisual(status) {
  const s = status.toLowerCase();
  membershipStatusEl.textContent = status;
  membershipStatusEl.className = 'status-pill mt-2';

  if (s === 'approved' || s === 'active') {
    membershipStatusEl.classList.add('bg-green-500', 'text-white');
  } else if (s === 'pending' || s === 'incomplete') {
    membershipStatusEl.classList.add('bg-yellow-400', 'text-gray-900');
  } else {
    membershipStatusEl.classList.add('bg-gray-600', 'text-white');
  }
}


function showIncompleteOnly() {
  incompleteSection.classList.remove('hidden');

  profileSection.classList.add('hidden');
  eventsPaymentsSection.classList.add('hidden');
  memberIDSection.classList.add('hidden');
}

function showFullDashboard() {
  incompleteSection.classList.add('hidden');

  profileSection.classList.remove('hidden');
  eventsPaymentsSection.classList.remove('hidden');
  memberIDSection.classList.remove('hidden');
}

function showTopNotice(msg, type='info') {
  const el = document.getElementById('topNotice');
  el.textContent = msg;
  el.className = 'p-3 rounded text-sm';
  el.classList.add(type === 'error' ? 'bg-red-600' :
                   type === 'success' ? 'bg-green-600' :
                   'bg-indigo-700', 'text-white');
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 3000);
}

/* ---------------------------
   Auth & Profile
--------------------------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }

  emailBadge.textContent = user.email || user.uid;
  logoutBtn.classList.remove('hidden');

  const userRef = doc(db, 'members', user.uid);

  onSnapshot(userRef, async (snap) => {
    if (!snap.exists()) {
      await setDoc(userRef, {
        name: user.email?.split('@')[0] || 'Member',
        role: 'Member',
        membership_status: 'Incomplete',
        memberID: generateMemberID(user.uid)
      }, { merge: true });
      
      // when user doc does not exist
      currentMembershipStatus = 'incomplete';
      setStatusVisual('Incomplete');
      showIncompleteOnly(); // ✅ FIXED
      return;
    if (currentMembershipStatus === 'approved') {
        window.location.href = 'profile.html';
    }
    if (currentMembershipStatus === 'approved' || currentMembershipStatus === 'active') {
      profileBtn.classList.remove('hidden');
    } else {
      profileBtn.classList.add('hidden');
    }


    const data = snap.data();
    currentMembershipStatus = (data.membership_status || 'incomplete').toLowerCase();

    setStatusVisual(data.membership_status || 'Incomplete');

    memberNameEl.textContent = data.name || 'Member Name';
    memberRoleEl.textContent = data.role || 'Member';
    memberNumberEl.textContent = data.memberID || generateMemberID(user.uid);

    if (currentMembershipStatus === 'approved') {
      showFullDashboard();
    } else {
      showIncompleteOnly();
    }
  });
});

/* ---------------------------
   Certificate Download (LOCKED)
--------------------------- */
downloadMemberIDBtn.addEventListener('click', () => {
  if (!['approved', 'active'].includes(currentMembershipStatus)) {
    showTopNotice('Certificate available only after approval', 'error');
    return;
  }
  generatePDF();
});

/* ---------------------------
   Certificate PDF
--------------------------- */
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const w = doc.internal.pageSize.getWidth();
  const h = doc.internal.pageSize.getHeight();

  doc.setFontSize(18);
  doc.text('Liberian Astronomical Society', w/2, 40, { align: 'center' });

  doc.setFontSize(14);
  doc.text('Certificate of Membership', w/2, 55, { align: 'center' });

  doc.setFontSize(20);
  doc.text(memberNameEl.textContent, w/2, 90, { align: 'center' });

  doc.setFontSize(12);
  doc.text(`Role: ${memberRoleEl.textContent}`, w/2, 105, { align: 'center' });
  doc.text(`Member ID: ${memberNumberEl.textContent}`, w/2, 115, { align: 'center' });

  const verifyURL = `${location.origin}/verify.html?cert=${memberNumberEl.textContent}`;

  QRCode.toDataURL(verifyURL).then(qr => {
    doc.addImage(qr, 'PNG', w - 80, h - 80, 60, 60);
    doc.save(`LAS_Certificate_${memberNameEl.textContent}.pdf`);
  });
}

/* ---------------------------
   Events
--------------------------- */
async function loadEvents() {
  const list = document.getElementById('eventsList');
  list.innerHTML = '';
  const snap = await getDocs(collection(db, 'events'));
  snap.forEach(d => {
    const e = d.data();
    const div = document.createElement('div');
    div.textContent = e.title;
    list.appendChild(div);
  });
}
refreshEventsBtn.addEventListener('click', loadEvents);

/* ---------------------------
   Payments
--------------------------- */
addPaymentBtn.addEventListener('click', async () => {
  const amount = parseFloat(document.getElementById('paymentAmount').value);
  if (!amount || amount <= 0) return showTopNotice('Invalid amount', 'error');

  await addDoc(collection(db, 'members', auth.currentUser.uid, 'payments'), {
    amount, date: new Date()
  });
  showTopNotice('Payment recorded', 'success');
});

/* ---------------------------
   Logout
--------------------------- */
logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = 'login.html';
});

/* ---------------------------
   Init
--------------------------- */
loadEvents();
</script>
</body>
</html>



