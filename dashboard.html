<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LAS Dashboard — Profile · Events · Payments · Certificates · Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 10% 20%, #1e3a8a, #0c4a6e); color: #e5e7eb; min-height:100vh; }
    .glass { background: rgba(17,24,39,0.45); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.06); }
    .muted { color: #9ca3af; }
    .chip { background: rgba(255,255,255,0.03); padding: .25rem .5rem; border-radius: .5rem; font-size: .85rem; }
    .hidden-section { display: none; }
  </style>
</head>
<body class="p-6 flex items-start justify-center">

<div class="w-full max-w-6xl space-y-6" id="dashboardContainer">

  <!-- Header -->
  <header class="flex items-center justify-between mb-2">
    <div class="flex items-center space-x-4">
      <img src="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png" class="h-12 rounded-full" alt="LAS">
      <div>
        <h1 class="text-2xl font-bold">Liberian Astronomical Society — Dashboard</h1>
        <p class="muted text-sm">Profile · Events · Payments · Certificates · Admin</p>
      </div>
    </div>
    <div class="space-x-3">
      <span id="emailBadge" class="chip">Not signed in</span>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white hidden">Logout</button>
    </div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left column: Profile + Membership Status -->
    <section class="glass p-6 rounded-xl" id="profileSection">
      <h2 class="text-xl font-semibold mb-4">My Profile</h2>
      <div class="space-y-3">
        <img id="previewPhoto" src="" alt="profile" class="h-24 w-24 rounded-full object-cover border" />
        <label class="block text-sm">Full name</label>
        <input id="profileName" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700" />
        <label class="block text-sm mt-2">Role</label>
        <select id="profileRole" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700">
          <option>Student</option><option>Volunteer</option><option>Teacher</option><option>Researcher</option><option>Executive</option>
        </select>
        <label class="block text-sm mt-2">Photo URL</label>
        <input id="profilePhoto" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700" placeholder="https://..." />
        <label class="block text-sm mt-2">Short bio</label>
        <textarea id="profileBio" rows="3" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700"></textarea>

        <div class="flex gap-3 mt-3">
          <button id="saveProfile" class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">Save Profile</button>
          <button id="downloadID" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Download Member ID</button>
        </div>

        <div class="mt-4">
          <p class="muted text-sm">Membership Status:</p>
          <div id="membershipStatus" class="text-lg font-bold">Loading...</div>
        </div>
      </div>
    </section>

    <!-- Middle column: Events and Payments -->
    <section class="col-span-1 lg:col-span-1 space-y-6" id="eventsPaymentsSection">
      <!-- Events -->
      <div class="glass p-6 rounded-xl">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Events</h2>
          <div>
            <button id="refreshEvents" class="text-sm muted mr-2">Refresh</button>
            <button id="createEventBtn" class="bg-green-600 px-3 py-1 rounded text-white hidden">Create Event</button>
          </div>
        </div>
        <p class="muted text-sm mb-3">Upcoming LAS events. Click <em>Register</em> to join.</p>
        <div id="eventsList" class="space-y-3 max-h-64 overflow-auto"></div>
      </div>

      <!-- Payments -->
      <div class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">Payments & Dues</h2>
        <p class="muted text-sm mb-3">Your payment history and outstanding dues.</p>
        <div id="paymentsSummary" class="text-sm muted mb-3">Loading...</div>
        <div id="paymentsList" class="space-y-2 max-h-40 overflow-auto"></div>
        <div class="mt-3 flex gap-2">
          <input id="paymentAmount" type="number" placeholder="Amount (USD)" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-full"/>
          <button id="addPaymentBtn" class="bg-indigo-600 px-4 py-2 rounded">Add Payment</button>
        </div>
      </div>
    </section>

    <!-- Right column: Certificates & Admin Panel -->
    <section class="space-y-6" id="certAdminSection">

      <!-- Certificates -->
      <div class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">Certificates & Member ID</h2>
        <p class="muted text-sm mb-3">Issue or download training certificates and your member ID.</p>
        <div id="certificateStatus" class="mb-3 muted">No certificate issued yet.</div>
        <div class="flex gap-2">
          <button id="generateCertBtn" class="bg-indigo-600 px-4 py-2 rounded">Generate Certificate</button>
          <button id="downloadCertBtn" class="bg-gray-600 px-4 py-2 rounded hidden">Download Certificate</button>
        </div>
      </div>

      <!-- Admin Panel -->
      <div id="adminPanel" class="glass p-6 rounded-xl hidden">
        <h2 class="text-xl font-semibold">Admin Panel</h2>
        <p class="muted text-sm mb-3">Approve members, view payments, create events.</p>
        <div class="mb-3">
          <h3 class="font-semibold">Pending Members</h3>
          <div id="pendingMembers" class="space-y-2 max-h-36 overflow-auto"></div>
        </div>
      </div>
    </section>

    <!-- Incomplete / Pending section -->
    <div id="incompleteSection" class="glass p-6 rounded-xl mt-6 hidden col-span-3">
      <h2 class="text-xl font-semibold">Complete Your Membership Application</h2>
      <p class="muted text-sm mb-3">Your membership is not yet fully approved. Please complete your application to access the full dashboard.</p>
      <a href="membership_application.html">
        <button class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">Go to Application Form</button>
      </a>
    </div>

  </main>

  <!-- Message modal -->
  <div id="msg" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="bg-gray-900 p-6 rounded shadow-lg max-w-md w-full">
      <div id="msgText" class="text-white"></div>
      <div class="mt-4 text-right">
        <button id="closeMsg" class="px-4 py-2 rounded bg-indigo-600">Close</button>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAX8le3vbPja0UfSUR2UvEMCkUxkQQPvks",
    authDomain: "liberian-astro-society.firebaseapp.com",
    projectId: "liberian-astro-society",
    storageBucket: "liberian-astro-society.firebasestorage.app",
    messagingSenderId: "914979035379",
    appId: "1:914979035379:web:ad9a2dbb05ebd48c407f86"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const emailBadge = document.getElementById('emailBadge');
  const logoutBtn = document.getElementById('logoutBtn');
  const incompleteSection = document.getElementById('incompleteSection');
  const profileSection = document.getElementById('profileSection');
  const eventsPaymentsSection = document.getElementById('eventsPaymentsSection');
  const certAdminSection = document.getElementById('certAdminSection');
  const membershipStatusEl = document.getElementById('membershipStatus');

  onAuthStateChanged(auth, async (user) => {
    if (!user) { await signInAnonymously(auth); return; }

    emailBadge.textContent = user.email || user.uid;
    logoutBtn.classList.remove('hidden');

    const userDocRef = doc(db, 'members', user.uid);

    onSnapshot(userDocRef, (snap) => {
      if (!snap.exists()) {
        setDoc(userDocRef, {status:'Incomplete', name:user.email?user.email.split('@')[0]:'Member', email:user.email||'', accepted:false},{merge:true});
        membershipStatusEl.textContent = 'Incomplete';
        showIncompleteView();
        return;
      }
      const data = snap.data();
      membershipStatusEl.textContent = data.status || 'Pending';

      if(data.status==='Incomplete' || data.status==='Pending'){
        showIncompleteView();
      } else if(data.status==='Admitted' || data.status==='Accepted'){
        showFullDashboard();
      }
    });
  });

  // LOGOUT — now redirects to signup.html
  logoutBtn.addEventListener('click', async () => { 
    await signOut(auth); 
    window.location.href = "signup.html"; 
  });

  function showIncompleteView(){
    incompleteSection.classList.remove('hidden');
    profileSection.classList.add('hidden');
    eventsPaymentsSection.classList.add('hidden');
    certAdminSection.classList.add('hidden');
  }

  function showFullDashboard(){
    incompleteSection.classList.add('hidden');
    profileSection.classList.remove('hidden');
    eventsPaymentsSection.classList.remove('hidden');
    certAdminSection.classList.remove('hidden');
  }

</script>
</body>
</html>
