<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LAS Dashboard — Profile · Events · Payments</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg,#071126 0%, #011026 60%); color: #e5e7eb; min-height:100vh; }
    .glass { background: rgba(17,24,39,0.45); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
    .muted { color: #9ca3af; }
    .chip { background: rgba(255,255,255,0.03); padding: .25rem .5rem; border-radius: .5rem; font-size: .85rem; }
    .status-pill { font-weight: 700; border-radius: 9999px; padding: .35rem .75rem; display: inline-flex; align-items: center; gap: .5rem; }
  </style>
</head>
<body class="p-6 flex items-start justify-center">

<div class="w-full max-w-6xl space-y-6" id="dashboardContainer">

  <!-- Header -->
  <header class="flex items-center justify-between mb-2">
    <div class="flex items-center space-x-4">
      <img src="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png" class="h-12 rounded-full" alt="LAS">
      <div>
        <h1 class="text-2xl font-bold">Liberian Astronomical Society — Dashboard</h1>
        <p class="muted text-sm">Profile · Events · Payments</p>
      </div>
    </div>
    <div class="space-x-3">
      <span id="emailBadge" class="chip">Not signed in</span>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white hidden">Logout</button>
    </div>
  </header>

  <div id="topNotice" class="hidden max-w-6xl mx-auto p-3 rounded-md text-sm"></div>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left column: Profile + Membership Status -->
    <section class="glass p-6 rounded-xl" id="profileSection">
      <h2 class="text-xl font-semibold mb-4">My Profile</h2>
      <div class="space-y-3">
        <img id="previewPhoto" src="https://via.placeholder.com/150" alt="profile" class="h-24 w-24 rounded-full object-cover border" />
        <label class="block text-sm">Full name</label>
        <input id="profileName" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700" />
        <label class="block text-sm mt-2">Role</label>
        <select id="profileRole" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700">
          <option>Student</option>
          <option>Volunteer</option>
          <option>Teacher</option>
          <option>Researcher</option>
          <option>Executive</option>
        </select>
        <label class="block text-sm mt-2">Photo URL</label>
        <input id="profilePhoto" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700" placeholder="https://..." />
        <label class="block text-sm mt-2">Short bio</label>
        <textarea id="profileBio" rows="3" class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700"></textarea>

        <div class="flex gap-3 mt-3">
          <button id="saveProfile" class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">Save Profile</button>
          <button id="downloadProfileID" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Download Member ID</button>
        </div>

        <div class="mt-4">
          <p class="muted text-sm">Membership status</p>
          <div id="membershipStatus" class="inline-flex items-center gap-2 mt-2 status-pill px-3 py-1 rounded-full bg-yellow-400 text-gray-900 font-semibold">Loading...</div>
        </div>
      </div>
    </section>

    <!-- Middle column: Events and Payments -->
    <section class="col-span-1 lg:col-span-1 space-y-6" id="eventsPaymentsSection">
      <!-- Events -->
      <div class="glass p-6 rounded-xl">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Events</h2>
          <button id="refreshEvents" class="text-sm muted">Refresh</button>
        </div>
        <p class="muted text-sm mb-3">Upcoming LAS events. Click <em>Register</em> to join.</p>
        <div id="eventsList" class="space-y-3 max-h-64 overflow-auto"></div>
      </div>

      <!-- Payments -->
      <div class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">Payments & Dues</h2>
        <p class="muted text-sm mb-3">Your payment history and outstanding dues.</p>
        <div id="paymentsSummary" class="text-sm muted mb-3">Loading...</div>
        <div id="paymentsList" class="space-y-2 max-h-40 overflow-auto"></div>
        <div class="mt-3 flex gap-2">
          <input id="paymentAmount" type="number" placeholder="Amount (USD)" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-full"/>
          <button id="addPaymentBtn" class="bg-indigo-600 px-4 py-2 rounded">Add Payment</button>
        </div>
      </div>
    </section>

    <!-- Right column: Member ID -->
    <section class="space-y-6" id="memberIDSectionWrapper">
      <div id="memberIDSection" class="glass p-6 rounded-xl">
        <h2 class="text-xl font-semibold">My Member ID</h2>
        <p class="muted text-sm mb-3">View and download your membership ID.</p>
        <div id="memberIDDisplay" class="mb-3">
          <p id="memberName" class="font-semibold"></p>
          <p id="memberRole" class="muted"></p>
          <p id="memberNumber" class="muted"></p>
        </div>
        <div class="flex gap-2 mb-3">
          <button id="downloadMemberID" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">Download Member ID</button>
          <button id="downloadCertificate" class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700 text-white">Download Certificate</button>
        </div>

        <!-- Certificate settings (signature upload) -->
        <div class="mt-4 border-t pt-4">
          <h4 class="text-sm font-semibold mb-2">Certificate settings</h4>
          <p class="text-xs muted mb-2">Upload the President's signature used on membership certificates.</p>

          <div class="space-y-2">
            <label class="block text-xs">Signature file</label>
            <input id="signatureFile" type="file" accept="image/*" class="text-sm w-full" />

            <label class="block text-xs mt-2">Or use image URL</label>
            <input id="signatureUrl" type="url" placeholder="https://..." class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-white text-sm" />

            <div class="flex items-center gap-3 mt-3">
              <img id="signaturePreview" src="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/Signature.jpg" alt="Signature preview" class="h-12 object-contain" />
              <div class="flex gap-2">
                <button id="saveSignatureBtn" class="bg-green-600 px-3 py-1 rounded text-sm text-white">Save signature</button>
                <button id="useGithubSigBtn" class="bg-gray-700 px-3 py-1 rounded text-sm">Use GitHub signature</button>
              </div>
            </div>
            <p id="signatureAdminNotice" class="text-xs muted mt-2 hidden">Only administrators can update this signature. Contact <a href="mailto:admin@liberianastronomicalsociety.org" class="underline">admin@liberianastronomicalsociety.org</a> to request changes.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Incomplete / Pending section -->
    <div id="incompleteSection" class="glass p-6 rounded-xl mt-6 hidden col-span-3">
      <h2 class="text-xl font-semibold">Complete Your Membership Application</h2>
      <p class="muted text-sm mb-3">Your membership isn't fully verified yet — please complete your application or contact an administrator for assistance.</p>
      <div class="flex gap-3">
        <a href="membership_application.html" class="inline-block"><button class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700">Complete Profile</button></a>
        <a href="mailto:admin@liberianastronomicalsociety.org" class="inline-block"><button class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600">Contact Admin</button></a>
      </div>
    </div>

  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs, getDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAX8le3vbPja0UfSUR2UvEMCkUxkQQPvks",
  authDomain: "liberian-astro-society.firebaseapp.com",
  projectId: "liberian-astro-society",
  storageBucket: "liberian-astro-society.firebasestorage.app",
  messagingSenderId: "914979035379",
  appId: "1:914979035379:web:ad9a2dbb05ebd48c407f86"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------------------
   DOM Elements
--------------------------- */
const emailBadge = document.getElementById('emailBadge');
const logoutBtn = document.getElementById('logoutBtn');
const incompleteSection = document.getElementById('incompleteSection');
const profileSection = document.getElementById('profileSection');
const eventsPaymentsSection = document.getElementById('eventsPaymentsSection');
const memberIDSection = document.getElementById('memberIDSection');
const membershipStatusEl = document.getElementById('membershipStatus');

const memberNameEl = document.getElementById('memberName');
const memberRoleEl = document.getElementById('memberRole');
const memberNumberEl = document.getElementById('memberNumber');

const saveProfileBtn = document.getElementById('saveProfile');
const downloadProfileIDBtn = document.getElementById('downloadProfileID');
const downloadMemberIDBtn = document.getElementById('downloadMemberID');
const addPaymentBtn = document.getElementById('addPaymentBtn');
const refreshEventsBtn = document.getElementById('refreshEvents');

const profilePhotoInput = document.getElementById('profilePhoto');
const previewPhoto = document.getElementById('previewPhoto');

// Certificate settings elements
const signatureFile = document.getElementById('signatureFile');
const signatureUrl = document.getElementById('signatureUrl');
const signaturePreview = document.getElementById('signaturePreview');
const saveSignatureBtn = document.getElementById('saveSignatureBtn');
const useGithubSigBtn = document.getElementById('useGithubSigBtn');

let presidentSignature = null; // will hold data URL or external URL
let siteSettings = null;
let isAdmin = false;

async function loadSiteSettings() {
  try {
    const ref = doc(db, 'settings', 'site');
    const snap = await getDoc(ref);
    if (snap.exists()) {
      siteSettings = snap.data();
    } else {
      siteSettings = {};
    }
  } catch (err) {
    console.warn('Could not load site settings:', err.message);
    siteSettings = {};
  }
}

function updateSignatureUIForAdmin() {
  const notice = document.getElementById('signatureAdminNotice');
  if (isAdmin) {
    signatureFile && (signatureFile.disabled = false);
    signatureUrl && (signatureUrl.disabled = false);
    saveSignatureBtn && (saveSignatureBtn.disabled = false);
    useGithubSigBtn && (useGithubSigBtn.disabled = false);
    if (notice) notice.classList.add('hidden');
  } else {
    signatureFile && (signatureFile.disabled = true);
    signatureUrl && (signatureUrl.disabled = true);
    saveSignatureBtn && (saveSignatureBtn.disabled = true);
    useGithubSigBtn && (useGithubSigBtn.disabled = true);
    if (notice) notice.classList.remove('hidden');
  }
}

function checkAdminForUser(user) {
  isAdmin = false;
  if (!user) { updateSignatureUIForAdmin(); return; }
  const email = (user.email || '').toLowerCase();
  const uid = (user.uid || '');

  if (siteSettings) {
    const emails = siteSettings.adminEmails || [];
    const uids = siteSettings.adminUIDs || [];
    if (emails.map(e => String(e).toLowerCase()).includes(email)) isAdmin = true;
    if (uids.includes(uid)) isAdmin = true;
  }

  // Fallback allow-list (use carefully)
  const fallbackAdmins = ['admin@liberianastronomicalsociety.org'];
  if (fallbackAdmins.includes(email)) isAdmin = true;

  updateSignatureUIForAdmin();
}

/* ---------------------------
   Authentication & Status
--------------------------- */
// Helper: update membership status visual
  function setStatusVisual(status) {
    const s = String(status || 'Incomplete');
    membershipStatusEl.textContent = s;
    membershipStatusEl.className = 'inline-flex items-center gap-2 mt-2 status-pill px-3 py-1 rounded-full font-semibold';

    if (s.toLowerCase() === 'approved' || s.toLowerCase() === 'active') membershipStatusEl.classList.add('bg-green-500', 'text-white');
    else if (s.toLowerCase() === 'pending' || s.toLowerCase() === 'incomplete') membershipStatusEl.classList.add('bg-yellow-400', 'text-gray-900');
    else membershipStatusEl.classList.add('bg-gray-600', 'text-white');
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) { 
      await signInAnonymously(auth); 
      return; 
    }

    emailBadge.textContent = user.email || user.uid;
    logoutBtn.classList.remove('hidden');

    // Load site settings and determine admin rights
    await loadSiteSettings();
    checkAdminForUser(user);

    const userDocRef = doc(db, 'members', user.uid);

    onSnapshot(userDocRef, (snap) => {
      if (!snap.exists()) {
        setDoc(userDocRef, { 
          membership_status: 'Incomplete', 
          name: user.email ? user.email.split('@')[0] : 'Member', 
          email: user.email || '', 
          role: 'Member' 
        }, { merge: true });

        setStatusVisual('Incomplete');
        showIncompleteView();
        return;
      }

      const data = snap.data();
      const status = data.membership_status || data.status || 'Incomplete';
      setStatusVisual(status);

      if (String(status).toLowerCase() === 'incomplete' || String(status).toLowerCase() === 'pending') {
        showIncompleteView();
        populateProfile(data, user.uid);
      } else {
        showFullDashboard();
        populateProfile(data, user.uid);
      }
    });
  });

/* ---------------------------
   Show / Hide Views
--------------------------- */
function showIncompleteView() {
  incompleteSection.classList.remove('hidden');
  profileSection.classList.add('hidden');
  eventsPaymentsSection.classList.add('hidden');
  memberIDSection.classList.add('hidden');
}

function showFullDashboard() {
  incompleteSection.classList.add('hidden');
  profileSection.classList.remove('hidden');
  eventsPaymentsSection.classList.remove('hidden');
  memberIDSection.classList.remove('hidden');
}

/* ---------------------------
   Profile Handling
--------------------------- */
function populateProfile(data, uid) {
  memberNameEl.textContent = data.name || 'Member Name';
  memberRoleEl.textContent = data.role || 'Role';
  memberNumberEl.textContent = data.memberID || uid;

  document.getElementById('profileName').value = data.name || '';
  document.getElementById('profileRole').value = data.role || 'Member';
  document.getElementById('profilePhoto').value = data.photo || '';
  document.getElementById('profileBio').value = data.bio || '';
  previewPhoto.src = data.photo || 'https://via.placeholder.com/150';
}

// Top notice helper
function showTopNotice(message, type = 'info', timeout = 3000) {
  const top = document.getElementById('topNotice');
  top.textContent = message;
  top.className = 'max-w-6xl mx-auto p-3 rounded-md text-sm';
  if (type === 'success') top.classList.add('bg-green-600', 'text-white');
  else if (type === 'error') top.classList.add('bg-red-600', 'text-white');
  else top.classList.add('bg-indigo-700', 'text-white');
  top.classList.remove('hidden');
  setTimeout(() => { top.classList.add('hidden'); }, timeout);
}

// Load president signature from Firestore settings if available
async function loadPresidentSignature() {
  try {
    const ref = doc(db, 'settings', 'president');
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      presidentSignature = data.signature || data.signatureUrl || null;
      if (presidentSignature) signaturePreview.src = presidentSignature;
    }
  } catch (err) {
    console.warn('Could not load president signature:', err.message);
  }
}

// Signature UI handlers
signatureFile && signatureFile.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    presidentSignature = reader.result; // data URL
    signaturePreview.src = presidentSignature;
    signatureUrl.value = '';
  };
  reader.readAsDataURL(f);
});

signatureUrl && signatureUrl.addEventListener('input', () => {
  const v = signatureUrl.value.trim();
  if (!v) return;
  presidentSignature = v;
  signaturePreview.src = v;
});

useGithubSigBtn && useGithubSigBtn.addEventListener('click', (e) => {
  e.preventDefault();
  const githubRaw = 'https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/Signature.jpg';
  signatureUrl.value = githubRaw;
  presidentSignature = githubRaw;
  signaturePreview.src = githubRaw;
});

saveSignatureBtn && saveSignatureBtn.addEventListener('click', async () => {
  if (!isAdmin) return showTopNotice('Only administrators can update the signature', 'error');
  if (!presidentSignature) return showTopNotice('No signature selected', 'error');
  try {
    await setDoc(doc(db, 'settings', 'president'), { signature: presidentSignature, name: 'Mr. Daniel A. Obajemu', title: 'President' }, { merge: true });
    showTopNotice('Signature saved', 'success');
  } catch (err) {
    showTopNotice('Failed to save signature: ' + err.message, 'error');
  }
});

// kick off settings & signature load
loadSiteSettings().then(() => {
  loadPresidentSignature();
});

// Save Profile
saveProfileBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) return;

  saveProfileBtn.disabled = true;
  try {
    const userDocRef = doc(db, 'members', user.uid);
    await setDoc(userDocRef, {
      name: document.getElementById('profileName').value,
      role: document.getElementById('profileRole').value,
      photo: document.getElementById('profilePhoto').value,
      bio: document.getElementById('profileBio').value,
      membership_status: 'Active'
    }, { merge: true });

    previewPhoto.src = document.getElementById('profilePhoto').value || 'https://via.placeholder.com/150';
    showTopNotice('Profile saved successfully!', 'success');
  } catch (err) {
    showTopNotice('Failed to save profile: ' + err.message, 'error');
  } finally {
    saveProfileBtn.disabled = false;
  }
});

// Live profile photo preview
profilePhotoInput.addEventListener('input', () => {
  previewPhoto.src = profilePhotoInput.value || 'https://via.placeholder.com/150';
});

/* ---------------------------
   Member ID / Membership Certificate (Professional NGO design)
--------------------------- */
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const width = doc.internal.pageSize.getWidth();
  const height = doc.internal.pageSize.getHeight();

  // Outer frame
  doc.setDrawColor(20, 34, 77);
  doc.setLineWidth(3);
  doc.rect(24, 24, width - 48, height - 48);
  doc.setLineWidth(1);
  doc.rect(32, 32, width - 64, height - 64);

  const logoUrl = 'https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png';
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.src = logoUrl;

  img.onload = () => {
    // Header: logo + organization name
    const logoW = 120;
    const logoH = (img.height / img.width) * logoW;
    const centerX = width / 2;
    doc.addImage(img, 'PNG', centerX - (logoW/2), 48, logoW, logoH);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text('Liberian Astronomical Society', centerX, 48 + logoH + 28, { align: 'center' });

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(14);
    doc.text('Certificate of Membership', centerX, 48 + logoH + 50, { align: 'center' });

    // Decorative separator
    doc.setDrawColor(180);
    doc.setLineWidth(0.7);
    doc.line(60, 48 + logoH + 62, width - 60, 48 + logoH + 62);

    // Member name
    const name = (memberNameEl.textContent || 'Member Name').trim();
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(22);
    doc.setTextColor(20, 24, 48);
    doc.text(name, centerX, 48 + logoH + 110, { align: 'center' });

    // Role and Member ID
    doc.setFontSize(11.5);
    doc.setFont('helvetica', 'normal');
    const role = memberRoleEl.textContent || 'Member';
    const memId = memberNumberEl.textContent || '';
    doc.setTextColor(60);
    doc.text(`Role: ${role}`, centerX, 48 + logoH + 140, { align: 'center' });
    doc.text(`Member ID: ${memId}`, centerX, 48 + logoH + 155, { align: 'center' });

    // Certification paragraph
    doc.setFontSize(11);
    doc.setTextColor(80);
    const certText = `This is to certify that the person named above is a registered member in good standing of the Liberian Astronomical Society. Membership entitles the holder to participate in LAS programs, events, and community activities in accordance with our policies.`;
    doc.text(certText, 72, 48 + logoH + 190, { maxWidth: width - 144, align: 'left' });

    // Issue date and certificate number
    const issued = new Date();
    const issueStr = issued.toLocaleDateString();
    doc.setFontSize(10.5);
    doc.setTextColor(30);
    doc.text(`Date of issue: ${issueStr}`, 72, height - 120);
    if (memId) doc.text(`Certificate No: ${memId}`, 72, height - 102);

    // Signature line
    const sigX = width - 240;
    doc.setDrawColor(30);
    doc.setLineWidth(0.8);
    doc.line(sigX, height - 120, sigX + 160, height - 120);
    doc.setFontSize(11);
    doc.text('President, Liberian Astronomical Society', sigX + 6, height - 98);

    // Insert signature image if available (async)
    function finalizeWithSignature() {
      if (presidentSignature) {
        const sigImg = new Image();
        sigImg.crossOrigin = 'anonymous';
        sigImg.src = presidentSignature;
        sigImg.onload = () => {
          const w = 140; const h = (sigImg.height / sigImg.width) * w;
          doc.addImage(sigImg, 'PNG', sigX + 8, height - 160, w, h);
          finalizeQR();
        };
        sigImg.onerror = () => { finalizeQR(); };
      } else {
        finalizeQR();
      }
    }

    // Seal (simple circle with text)
    doc.setDrawColor(120);
    doc.circle(96, height - 110, 36);
    doc.setFontSize(9);
    doc.text('OFFICIAL', 96, height - 122, { align: 'center' });
    doc.text('SEAL', 96, height - 108, { align: 'center' });

    // Footer small print
    doc.setFontSize(9);
    doc.setTextColor(110);
    doc.text('Liberian Astronomical Society — LAS. Registered NGO. For verification contact admin@liberianastronomicalsociety.org', centerX, height - 40, { align: 'center', maxWidth: width - 120 });

    // QR code and save
    function finalizeQR() {
      const certId = memId || (window.auth && window.auth.currentUser && window.auth.currentUser.uid) || '';
      const verificationUrl = `${location.origin}${location.pathname.replace(/[^/]*$/, '')}verify.html?cert=${encodeURIComponent(certId)}`;
      // generate QR
      if (typeof QRCode !== 'undefined' && verificationUrl) {
        QRCode.toDataURL(verificationUrl, { width: 110 }).then((qrDataUrl) => {
          doc.addImage(qrDataUrl, 'PNG', width - 140, height - 190, 100, 100);
          const safeName = name.replace(/[^a-z0-9_\-]/gi, '_');
          doc.save(`LAS_Certificate_${safeName || 'member'}.pdf`);
        }).catch(() => {
          const safeName = name.replace(/[^a-z0-9_\-]/gi, '_');
          doc.save(`LAS_Certificate_${safeName || 'member'}.pdf`);
        });
      } else {
        const safeName = name.replace(/[^a-z0-9_\-]/gi, '_');
        doc.save(`LAS_Certificate_${safeName || 'member'}.pdf`);
      }
    }

    // start signature/qr finalization
    finalizeWithSignature();
  };
}
downloadProfileIDBtn.addEventListener('click', generatePDF);
downloadMemberIDBtn.addEventListener('click', generatePDF);

/* ---------------------------
   Payments
--------------------------- */
addPaymentBtn.addEventListener('click', async () => {
  const amountInput = document.getElementById('paymentAmount');
  const amount = parseFloat(amountInput.value);
  if (isNaN(amount) || amount <= 0) return showTopNotice('Enter a valid amount', 'error');

  addPaymentBtn.disabled = true;
  try {
    const user = auth.currentUser;
    const paymentsRef = collection(db, 'members', user.uid, 'payments');
    await addDoc(paymentsRef, { amount, date: new Date() });

    amountInput.value = '';
    showTopNotice('Payment recorded', 'success');
    loadPayments();
  } catch (err) {
    showTopNotice('Failed to record payment: ' + err.message, 'error');
  } finally {
    addPaymentBtn.disabled = false;
  }
});

async function loadPayments() {
  const user = auth.currentUser;
  if (!user) return;

  const paymentsListEl = document.getElementById('paymentsList');
  paymentsListEl.innerHTML = '';

  const paymentsRef = collection(db, 'members', user.uid, 'payments');
  const snapshot = await getDocs(paymentsRef);

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement('div');
    div.textContent = `USD ${data.amount} — ${data.date.toDate().toLocaleDateString()}`;
    paymentsListEl.appendChild(div);
  });
}

/* ---------------------------
   Events
--------------------------- */
refreshEventsBtn.addEventListener('click', loadEvents);

async function loadEvents() {
  const eventsListEl = document.getElementById('eventsList');
  eventsListEl.innerHTML = '';

  const eventsSnapshot = await getDocs(collection(db, 'events'));
  eventsSnapshot.forEach(docSnap => {
    const event = docSnap.data();
    const div = document.createElement('div');
    div.classList.add('glass', 'p-2', 'rounded');
    const btnID = 'register_' + docSnap.id;

    div.innerHTML = `
      <p class="font-semibold">${event.title}</p>
      <p class="text-sm muted">${event.date}</p>
      <button id="${btnID}" class="bg-indigo-600 px-2 py-1 mt-1 rounded text-sm hover:bg-indigo-700">Register</button>
    `;
    eventsListEl.appendChild(div);

    document.getElementById(btnID).addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      const regRef = collection(db, 'members', user.uid, 'registrations');
      await addDoc(regRef, { eventID: docSnap.id, title: event.title, date: new Date() });
      showTopNotice(`Registered for ${event.title}`, 'success');
    });
  });
}

/* ---------------------------
   Logout
--------------------------- */
logoutBtn.addEventListener('click', async () => { 
  await signOut(auth); 
  window.location.href = "login.html"; 
});

/* ---------------------------
   Initial Load
--------------------------- */
loadEvents();
loadPayments();
</script>

</body>
</html>

