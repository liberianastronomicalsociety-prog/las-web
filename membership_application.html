<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Membership Application</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/liberianastronomicalsociety-prog/las-web/main/LAS%20official%20logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes starry-glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0d1117;
            background-image: 
                linear-gradient(rgba(12, 74, 110, 0.7), rgba(30, 58, 138, 0.7)),
                url('https://images.unsplash.com/photo-1518173946274-3298186f885e?q=80&w=1740&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #d1d5db;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 20%, rgba(255, 255, 255, 0.05) 80%, transparent 100%);
            background-size: 200% 200%;
            animation: starry-glow 30s ease-in-out infinite;
            pointer-events: none;
        }

        .form-card {
            background-color: rgba(17, 24, 39, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        input, select, textarea {
            background-color: rgba(31, 41, 55, 0.7);
            border-color: rgba(75, 85, 99, 0.5);
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 min-h-screen">

    <div class="form-card p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-4xl mx-auto my-8">
        <div class="flex flex-col items-center mb-6">
            <h2 class="text-3xl sm:text-4xl font-bold text-white text-center mb-2">Join the Liberian Astronomical Society</h2>
            <p class="text-gray-400 text-center text-lg max-w-2xl">
                Ready to take your passion for the cosmos to the next level? Fill out this application to begin your journey with us.
            </p>
            <p class="text-sm text-gray-400 text-center mt-2">
                User ID: <span id="userIdDisplay" class="font-mono text-xs">Loading...</span>
            </p>
        </div>

        <form id="membershipForm" class="space-y-8">
            <!-- Your Personal Information -->
            <div class="border-b border-gray-600 pb-6">
                <h3 class="text-2xl font-semibold text-white mb-4">Your Personal Information</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-300 mb-1">Full Name</label>
                        <input type="text" id="fullName" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-300 mb-1">Date of Birth</label>
                        <input type="date" id="dob" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-300 mb-1">Gender</label>
                        <select id="gender" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>Select your gender...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">Phone Number</label>
                        <input type="tel" id="phone" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="email" required disabled class="w-full px-4 py-2 text-white rounded-lg cursor-not-allowed bg-gray-600">
                    </div>
                </div>
            </div>

            <!-- Your School and Social Media -->
            <div class="border-b border-gray-600 pb-6">
                <h3 class="text-2xl font-semibold text-white mb-4">School & Social Information</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="schoolName" class="block text-sm font-medium text-gray-300 mb-1">Name of School</label>
                        <input type="text" id="schoolName" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="department" class="block text-sm font-medium text-gray-300 mb-1">College/Department</label>
                        <input type="text" id="department" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="major" class="block text-sm font-medium text-gray-300 mb-1">Major/Program of Study</label>
                        <input type="text" id="major" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="facebook" class="block text-sm font-medium text-gray-300 mb-1">Facebook Handle</label>
                        <input type="text" id="facebook" class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="instagram" class="block text-sm font-medium text-gray-300 mb-1">Instagram Handle</label>
                        <input type="text" id="instagram" class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="x" class="block text-sm font-medium text-gray-300 mb-1">X (Twitter) Handle</label>
                        <input type="text" id="x" class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="border-b border-gray-600 pb-6">
                <h3 class="text-2xl font-semibold text-white mb-4">Emergency Contact</h3>
                <p class="text-gray-400 text-sm mb-4">In case of an emergency, who should we contact?</p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="emergencyName" class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                        <input type="text" id="emergencyName" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="emergencyPhone" class="block text-sm font-medium text-gray-300 mb-1">Phone Number</label>
                        <input type="tel" id="emergencyPhone" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
            </div>

            <!-- Your Interests -->
            <div class="space-y-6">
                <h3 class="text-2xl font-semibold text-white mb-4">Your Interests & Experience</h3>
                <div>
                    <label for="whyJoin" class="block text-sm font-medium text-gray-300 mb-1">Why do you want to join the Liberian Astronomical Society?</label>
                    <textarea id="whyJoin" rows="4" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <div class="text-xs text-gray-400 mt-1">
                        Word count: <span id="whyJoinWordCount">0</span>/500
                    </div>
                </div>
                <div>
                    <label for="astronomyInterest" class="block text-sm font-medium text-gray-300 mb-1">What are your interests in astronomy?</label>
                    <textarea id="astronomyInterest" rows="4" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <div class="text-xs text-gray-400 mt-1">
                        Word count: <span id="astronomyInterestWordCount">0</span>/500
                    </div>
                </div>
                <div>
                    <label for="howHeard" class="block text-sm font-medium text-gray-300 mb-1">How did you hear about LAS?</label>
                    <textarea id="howHeard" rows="2" required class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div>
                    <label for="priorExperience" class="block text-sm font-medium text-gray-300 mb-1">Prior Experience in Astronomy</label>
                    <textarea id="priorExperience" rows="4" class="w-full px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Have you used a telescope before?"></textarea>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="border-b border-gray-600 pb-6">
                <h3 class="text-2xl font-semibold text-white mb-4">What's Next?</h3>
                <p class="text-gray-400 text-base mb-4">
                    Thank you for completing the initial application. After you submit this form, here are the next steps to become an official member of the Liberian Astronomical Society:
                </p>
                <ol class="list-decimal list-inside space-y-2 text-gray-300">
                    <li>You will be redirected to a **15-question assessment** to test your astronomy knowledge. You need a score of at least 8 to pass.</li>
                    <li>If you pass, you will be scheduled for an **interview with an administrator**.</li>
                    <li>After the interview, you will receive the **official membership form** and details for a one-time newcomer due of **$5 USD**, payable via Orange Money at `0772858306`.</li>
                    <li>Once everything is complete, you'll get your **official membership letter**!</li>
                </ol>
                <p class="text-gray-400 text-sm mt-4">
                    Remember, a monthly due of $500 LRD is required to maintain your active membership status.
                </p>
            </div>

            <!-- Terms & Conditions and Submit -->
            <div class="space-y-4 pt-6">
                <div class="flex items-start">
                    <input type="checkbox" id="terms" required class="mt-1 form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500 transition duration-150 ease-in-out bg-gray-700 border-gray-600">
                    <label for="terms" class="ml-2 block text-sm text-gray-300">
                        I hereby declare that the information provided is correct and true. I understand and agree to the terms and conditions of the Liberian Astronomical Society.
                    </label>
                </div>
                <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold shadow-lg hover:bg-indigo-700 transition-all duration-300">
                    Submit My Application
                </button>
                <div id="message" class="mt-4 text-center text-sm font-medium hidden"></div>
            </div>
        </form>
    </div>

    <!-- Firebase and JavaScript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // Enable debug logging for Firebase
        setLogLevel('debug');

        // Firebase and app ID globals
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyAX8le3vbPja0UfSUR2UvEMCkUxkQQPvks",
            authDomain: "liberian-astro-society.firebaseapp.com",
            projectId: "liberian-astro-society",
            storageBucket: "liberian-astro-society.firebasestorage.app",
            messagingSenderId: "914979035379",
            appId: "1:914979035379:web:ad9a2dbb05ebd48c407f86",
            measurementId: "G-RBC64CGK4J"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let userEmail = null;

        const messageElement = document.getElementById('message');

        function showMessage(msg, type) {
            messageElement.textContent = msg;
            messageElement.classList.remove('hidden', 'text-green-500', 'text-red-500', 'text-gray-400');
            if (type === 'success') {
                messageElement.classList.add('text-green-500', 'block');
            } else if (type === 'error') {
                messageElement.classList.add('text-red-500', 'block');
            } else {
                messageElement.classList.add('text-gray-400', 'block');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const membershipForm = document.getElementById('membershipForm');
            const emailInput = document.getElementById('email');
            const userIdDisplay = document.getElementById('userIdDisplay');
            const submitBtn = document.getElementById('submitBtn');
            const formInputs = membershipForm.querySelectorAll('input, textarea, select');
        
            const whyJoinTextarea = document.getElementById('whyJoin');
            const astronomyInterestTextarea = document.getElementById('astronomyInterest');
            const whyJoinWordCount = document.getElementById('whyJoinWordCount');
            const astronomyInterestWordCount = document.getElementById('astronomyInterestWordCount');
        
            function getWordCount(text) {
                return text.split(/\s+/).filter(word => word.length > 0).length;
            }
        
            whyJoinTextarea.addEventListener('input', () => {
                const count = getWordCount(whyJoinTextarea.value);
                whyJoinWordCount.textContent = count;
                whyJoinWordCount.style.color = (count < 300 || count > 500) ? '#f87171' : '#a7a7a7';
            });
        
            astronomyInterestTextarea.addEventListener('input', () => {
                const count = getWordCount(astronomyInterestTextarea.value);
                astronomyInterestWordCount.textContent = count;
                astronomyInterestWordCount.style.color = (count < 300 || count > 500) ? '#f87171' : '#a7a7a7';
            });
        
            async function checkAndLoadApplication(currentUserId) {
                try {
                    // Correctly form the document path according to the security rules
                    const applicationRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'members', currentUserId);
                    const docSnap = await getDoc(applicationRef);
        
                    if (docSnap.exists() && docSnap.data().submissionTimestamp) {
                        const data = docSnap.data();
                        
                        // Populate form fields
                        document.getElementById('fullName').value = data.fullName || '';
                        document.getElementById('dob').value = data.dateOfBirth || '';
                        document.getElementById('gender').value = data.gender || '';
                        document.getElementById('phone').value = data.phone || '';
                        document.getElementById('schoolName').value = data.schoolName || '';
                        document.getElementById('department').value = data.department || '';
                        document.getElementById('major').value = data.major || '';
                        document.getElementById('facebook').value = data.facebook || '';
                        document.getElementById('instagram').value = data.instagram || '';
                        document.getElementById('x').value = data.x || '';
                        document.getElementById('emergencyName').value = data.emergencyContactName || '';
                        document.getElementById('emergencyPhone').value = data.emergencyContactPhone || '';
                        document.getElementById('whyJoin').value = data.whyJoin || '';
                        document.getElementById('astronomyInterest').value = data.astronomyInterest || '';
                        document.getElementById('howHeard').value = data.howHeard || '';
                        document.getElementById('priorExperience').value = data.priorExperience || '';
                        document.getElementById('terms').checked = data.agreedToTerms || false;
        
                        // Disable all form inputs
                        formInputs.forEach(input => input.disabled = true);
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Application Already Submitted';
                        submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        submitBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
        
                        showMessage('Your application has already been submitted and is on file. You can view your information below.', 'success');
                    }
                } catch (error) {
                    console.error("Error checking for existing application: ", error);
                }
            }
        
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userEmail = user.email;
                    userIdDisplay.textContent = userId;
                    emailInput.value = userEmail || 'Not Available';
                    checkAndLoadApplication(userId);
                } else {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Firebase custom token sign-in failed. This likely indicates an issue with the provided authentication token.", error);
                            showMessage("Authentication failed. Please refresh the page. If the problem persists, there may be an issue with your account credentials.", 'error');
                        }
                    } else {
                        console.error("No authentication token provided.");
                        showMessage("Authentication failed. No token found.", 'error');
                    }
                }
            });
        
            membershipForm.addEventListener('submit', async (e) => {
                e.preventDefault();
        
                const whyJoinCount = getWordCount(whyJoinTextarea.value);
                const astronomyInterestCount = getWordCount(astronomyInterestTextarea.value);
        
                if (whyJoinCount < 300 || whyJoinCount > 500) {
                    showMessage('Please ensure your response for "Why join LAS?" is between 300 and 500 words.', 'error');
                    return;
                }
        
                if (astronomyInterestCount < 300 || astronomyInterestCount > 500) {
                    showMessage('Please ensure your response for "Interests in Astronomy" is between 300 and 500 words.', 'error');
                    return;
                }
        
                if (!userId) {
                    showMessage("User not authenticated. Please wait and try again.", 'error');
                    console.error("User ID is not available.");
                    return;
                }
        
                // Correctly form the document path for the current user's application
                const applicationRef = doc(db, 'artifacts', appId, 'users', userId, 'members', userId);
                const docSnap = await getDoc(applicationRef);
        
                if (docSnap.exists() && docSnap.data().submissionTimestamp) {
                    showMessage('You have already submitted an application. Thank you!', 'error');
                    return;
                }
        
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                showMessage('Submitting your application now...', 'info');
        
                const formData = {
                    fullName: document.getElementById('fullName').value,
                    dateOfBirth: document.getElementById('dob').value,
                    gender: document.getElementById('gender').value,
                    phone: document.getElementById('phone').value,
                    email: userEmail,
                    schoolName: document.getElementById('schoolName').value,
                    department: document.getElementById('department').value,
                    major: document.getElementById('major').value,
                    facebook: document.getElementById('facebook').value,
                    instagram: document.getElementById('instagram').value,
                    x: document.getElementById('x').value,
                    emergencyContactName: document.getElementById('emergencyName').value,
                    emergencyContactPhone: document.getElementById('emergencyContactPhone').value,
                    whyJoin: document.getElementById('whyJoin').value,
                    astronomyInterest: document.getElementById('astronomyInterest').value,
                    howHeard: document.getElementById('howHeard').value,
                    priorExperience: document.getElementById('priorExperience').value,
                    agreedToTerms: document.getElementById('terms').checked,
                    submissionTimestamp: serverTimestamp()
                };
        
                try {
                    await setDoc(applicationRef, formData, { merge: true });
                    
                    showMessage('Application submitted successfully! Redirecting you to the assessment...', 'success');
                    
                    // Redirect to the assessment page after a short delay
                    setTimeout(() => {
                        window.location.href = 'assessment.html'; 
                    }, 2000); // Redirects after 2 seconds
                    
                } catch (error) {
                    console.error("Error submitting document: ", error);
                    showMessage("Error submitting form. Please try again.", 'error');
                    
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit My Application';
                }
            });
        });
    </script>
</body>
</html>
